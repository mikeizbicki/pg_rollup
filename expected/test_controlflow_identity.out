SET client_min_messages TO WARNING;
create or replace language plpython3u;
create extension if not exists pgrollup;
create table testid (
    id int generated by default as identity primary key,
    name text,
    num int
);
insert into testid (name,num) values
    ('alice', 1),
    ('alice', 2),
    ('alice', 3),
    ('alice', 4),
    ('alice', 5),
    ('bill', 5),
    ('bill', 5),
    ('bill', 5),
    ('charlie', 1),
    ('charlie', 1),
    ('charlie', 1),
    ('charlie', 3),
    ('charlie', NULL),
    ('dave', 4),
    ('elliot', 5),
    (NULL, 1),
    (NULL, 1),
    (NULL, 1),
    (NULL, 1),
    (NULL, 1),
    (NULL, 8),
    (NULL, 9),
    (NULL, NULL),
    (NULL, NULL),
    (NULL, NULL),
    (NULL, NULL);
create materialized view testid_rollup1 as (
    select name,count(*)
    from testid
    group by name
);
select rollup_mode('testid_rollup1','manual');
 rollup_mode 
-------------
 
(1 row)

insert into testid (name,num) values
    ('alice', 1),
    ('alice', 2),
    ('alice', 3),
    ('alice', 4),
    ('alice', 5),
    ('bill', 5),
    ('bill', 5),
    ('bill', 5),
    ('charlie', 1),
    ('charlie', 1),
    ('charlie', 1),
    ('charlie', 3),
    ('charlie', NULL),
    ('dave', 4),
    ('elliot', 5),
    (NULL, 1),
    (NULL, 1),
    (NULL, 1),
    (NULL, 1),
    (NULL, 1),
    (NULL, 8),
    (NULL, 9),
    (NULL, NULL),
    (NULL, NULL),
    (NULL, NULL),
    (NULL, NULL);
select do_rollup('testid_rollup1');
           do_rollup           
-------------------------------
 (testid_rollup1,testid,27,52)
(1 row)

select assert_rollup('testid_rollup1');
 assert_rollup 
---------------
 
(1 row)

create table testid2 (
    id int generated always as identity primary key,
    name text,
    num int
);
insert into testid2 (name,num) values
    ('alice', 1),
    ('alice', 2),
    ('alice', 3),
    ('alice', 4),
    ('alice', 5),
    ('bill', 5),
    ('bill', 5),
    ('bill', 5),
    ('charlie', 1),
    ('charlie', 1),
    ('charlie', 1),
    ('charlie', 3),
    ('charlie', NULL),
    ('dave', 4),
    ('elliot', 5),
    (NULL, 1),
    (NULL, 1),
    (NULL, 1),
    (NULL, 1),
    (NULL, 1),
    (NULL, 8),
    (NULL, 9),
    (NULL, NULL),
    (NULL, NULL),
    (NULL, NULL),
    (NULL, NULL);
create materialized view testid2_rollup1 as (
    select name,count(*)
    from testid2
    group by name
);
select rollup_mode('testid2_rollup1','manual');
 rollup_mode 
-------------
 
(1 row)

insert into testid2 (name,num) values
    ('alice', 1),
    ('alice', 2),
    ('alice', 3),
    ('alice', 4),
    ('alice', 5),
    ('bill', 5),
    ('bill', 5),
    ('bill', 5),
    ('charlie', 1),
    ('charlie', 1),
    ('charlie', 1),
    ('charlie', 3),
    ('charlie', NULL),
    ('dave', 4),
    ('elliot', 5),
    (NULL, 1),
    (NULL, 1),
    (NULL, 1),
    (NULL, 1),
    (NULL, 1),
    (NULL, 8),
    (NULL, 9),
    (NULL, NULL),
    (NULL, NULL),
    (NULL, NULL),
    (NULL, NULL);
select do_rollup('testid2_rollup1');
            do_rollup            
---------------------------------
 (testid2_rollup1,testid2,27,52)
(1 row)

select assert_rollup('testid2_rollup1');
 assert_rollup 
---------------
 
(1 row)

drop table testid cascade;
drop table testid2 cascade;
