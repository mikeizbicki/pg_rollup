create or replace language plpython3u;
create extension if not exists hll;
NOTICE:  extension "hll" already exists, skipping
create extension if not exists pg_rollup;
NOTICE:  extension "pg_rollup" already exists, skipping
create extension if not exists datasketches;
CREATE OR REPLACE FUNCTION kll_float_sketch_union(a kll_float_sketch, b kll_float_sketch) RETURNS kll_float_sketch AS $$
    select kll_float_sketch_merge(sketch) from (select a as sketch union all select b) t;
$$ LANGUAGE 'sql' IMMUTABLE PARALLEL SAFE;
create table dstest (
    id serial primary key,
    a int
);
insert into dstest (a) (select * from generate_series(0,10000));
select create_rollup(
    'dstest',
    'dstest_rollup1',
    rollups => $$
        kll_float_sketch(a),
        theta_sketch(a)
    $$
);
 create_rollup 
---------------
 
(1 row)

-- FIXME:
-- kll_float_sketch is non-deterministic due to an internal random number generation;
-- this causes the groundtruth and the rollup table to diverge slightly,
-- and so we can't test for equality
--select assert_rollup('dstest_rollup1');
insert into dstest (a) (select * from generate_series(0,10000));
--select assert_rollup('dstest_rollup1');
