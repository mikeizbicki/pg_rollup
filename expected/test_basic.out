create or replace language plpython3u;
create extension if not exists hll;
NOTICE:  extension "hll" already exists, skipping
create extension if not exists topn;
create extension if not exists pg_rollup;
NOTICE:  extension "pg_rollup" already exists, skipping
create temporary table test (
    id serial primary key,
    name text,
    num int
);
insert into test (name,num) values
    ('alice', 1),
    ('alice', 2),
    ('alice', 3),
    ('alice', 4),
    ('alice', 5),
    ('bill', 5),
    ('bill', 5),
    ('bill', 5),
    ('charlie', 1),
    ('charlie', 1),
    ('charlie', 1),
    ('charlie', 3),
    ('charlie', NULL),
    ('dave', 4),
    ('elliot', 5),
    (NULL, 1),
    (NULL, 1),
    (NULL, 1),
    (NULL, 1),
    (NULL, 1),
    (NULL, 8),
    (NULL, 9),
    (NULL, NULL),
    (NULL, NULL),
    (NULL, NULL),
    (NULL, NULL);
select create_rollup(
    'test',
    'test_rollup1',
    wheres => 'name'
);
NOTICE:  view "test_rollup1_groundtruth_raw" will be a temporary view
NOTICE:  view "test_rollup1" will be a temporary view
NOTICE:  view "test_rollup1_groundtruth" will be a temporary view
 create_rollup 
---------------
 
(1 row)

select create_rollup(
    'test',
    'test_rollup2',
    wheres => 'name,num'
);
NOTICE:  view "test_rollup2_groundtruth_raw" will be a temporary view
NOTICE:  view "test_rollup2" will be a temporary view
NOTICE:  view "test_rollup2_groundtruth" will be a temporary view
 create_rollup 
---------------
 
(1 row)

select create_rollup(
    'test',
    'test_rollup3',
    wheres => 'name',
    rollups => 'hll(num)'
);
NOTICE:  view "test_rollup3_groundtruth_raw" will be a temporary view
NOTICE:  view "test_rollup3" will be a temporary view
NOTICE:  view "test_rollup3_groundtruth" will be a temporary view
 create_rollup 
---------------
 
(1 row)

select create_rollup(
    'test',
    'test_rollup4',
    rollups => $$
        hll(name),
        hll(num)
    $$
);
NOTICE:  view "test_rollup4_groundtruth_raw" will be a temporary view
NOTICE:  view "test_rollup4" will be a temporary view
NOTICE:  view "test_rollup4_groundtruth" will be a temporary view
 create_rollup 
---------------
 
(1 row)

select create_rollup(
    'test',
    'test_rollup5',
    wheres => 'name',
    rollups => $$
        sum(num) as sum,
        count(*) as count_all,
        count(num),
        max(num),
        min(num)
    $$
);
NOTICE:  view "test_rollup5_groundtruth_raw" will be a temporary view
NOTICE:  view "test_rollup5" will be a temporary view
NOTICE:  view "test_rollup5_groundtruth" will be a temporary view
 create_rollup 
---------------
 
(1 row)

select create_rollup(
    'test',
    'test_rollup6',
    rollups => $$
        sum(num) as sum,
        count(*) as count_all,
        count(num),
        max(num),
        min(num)
    $$
);
NOTICE:  view "test_rollup6_groundtruth_raw" will be a temporary view
NOTICE:  view "test_rollup6" will be a temporary view
NOTICE:  view "test_rollup6_groundtruth" will be a temporary view
 create_rollup 
---------------
 
(1 row)

select create_rollup(
    'test',
    'test_rollup7',
    wheres => 'num',
    rollups => $$
        topn(name)
    $$
);
NOTICE:  view "test_rollup7_groundtruth_raw" will be a temporary view
NOTICE:  view "test_rollup7" will be a temporary view
NOTICE:  view "test_rollup7_groundtruth" will be a temporary view
 create_rollup 
---------------
 
(1 row)

select assert_rollup('test_rollup1');
 assert_rollup 
---------------
 
(1 row)

select assert_rollup('test_rollup2');
 assert_rollup 
---------------
 
(1 row)

select assert_rollup('test_rollup3');
 assert_rollup 
---------------
 
(1 row)

select assert_rollup('test_rollup4');
 assert_rollup 
---------------
 
(1 row)

select assert_rollup('test_rollup5');
 assert_rollup 
---------------
 
(1 row)

select assert_rollup('test_rollup6');
 assert_rollup 
---------------
 
(1 row)

select assert_rollup('test_rollup7');
 assert_rollup 
---------------
 
(1 row)

insert into test (name,num) values
    ('alice', 1),
    ('alice', 2),
    ('alice', 3),
    ('alice', 4),
    ('alice', 5),
    ('bill', 5),
    ('bill', 5),
    ('bill', 5),
    ('charlie', 1),
    ('charlie', 1),
    ('charlie', 1),
    ('charlie', 3),
    ('charlie', NULL),
    ('dave', 4),
    ('elliot', 5),
    (NULL, 1),
    (NULL, 1),
    (NULL, 1),
    (NULL, 1),
    (NULL, 1),
    (NULL, 8),
    (NULL, 9),
    (NULL, NULL),
    (NULL, NULL),
    (NULL, NULL),
    (NULL, NULL);
select assert_rollup('test_rollup1');
 assert_rollup 
---------------
 
(1 row)

select assert_rollup('test_rollup2');
 assert_rollup 
---------------
 
(1 row)

select assert_rollup('test_rollup3');
 assert_rollup 
---------------
 
(1 row)

select assert_rollup('test_rollup4');
 assert_rollup 
---------------
 
(1 row)

select assert_rollup('test_rollup5');
 assert_rollup 
---------------
 
(1 row)

select assert_rollup('test_rollup6');
 assert_rollup 
---------------
 
(1 row)

select assert_rollup('test_rollup7');
 assert_rollup 
---------------
 
(1 row)

select drop_rollup('test_rollup1');
NOTICE:  drop cascades to view test_rollup1
NOTICE:  drop cascades to 3 other objects
DETAIL:  drop cascades to trigger test_rollup1_insert on table test
drop cascades to trigger test_rollup1_update on table test
drop cascades to trigger test_rollup1_delete on table test
 drop_rollup 
-------------
 
(1 row)

select drop_rollup('test_rollup2');
NOTICE:  drop cascades to view test_rollup2
NOTICE:  drop cascades to 3 other objects
DETAIL:  drop cascades to trigger test_rollup2_insert on table test
drop cascades to trigger test_rollup2_update on table test
drop cascades to trigger test_rollup2_delete on table test
 drop_rollup 
-------------
 
(1 row)

select drop_rollup('test_rollup3');
NOTICE:  drop cascades to view test_rollup3
NOTICE:  drop cascades to 3 other objects
DETAIL:  drop cascades to trigger test_rollup3_insert on table test
drop cascades to trigger test_rollup3_update on table test
drop cascades to trigger test_rollup3_delete on table test
 drop_rollup 
-------------
 
(1 row)

select drop_rollup('test_rollup4');
NOTICE:  drop cascades to view test_rollup4
NOTICE:  drop cascades to 3 other objects
DETAIL:  drop cascades to trigger test_rollup4_insert on table test
drop cascades to trigger test_rollup4_update on table test
drop cascades to trigger test_rollup4_delete on table test
 drop_rollup 
-------------
 
(1 row)

select drop_rollup('test_rollup5');
NOTICE:  drop cascades to view test_rollup5
NOTICE:  drop cascades to 3 other objects
DETAIL:  drop cascades to trigger test_rollup5_insert on table test
drop cascades to trigger test_rollup5_update on table test
drop cascades to trigger test_rollup5_delete on table test
 drop_rollup 
-------------
 
(1 row)

select drop_rollup('test_rollup6');
NOTICE:  drop cascades to view test_rollup6
NOTICE:  drop cascades to 3 other objects
DETAIL:  drop cascades to trigger test_rollup6_insert on table test
drop cascades to trigger test_rollup6_update on table test
drop cascades to trigger test_rollup6_delete on table test
 drop_rollup 
-------------
 
(1 row)

select drop_rollup('test_rollup7');
NOTICE:  drop cascades to view test_rollup7
NOTICE:  drop cascades to 3 other objects
DETAIL:  drop cascades to trigger test_rollup7_insert on table test
drop cascades to trigger test_rollup7_update on table test
drop cascades to trigger test_rollup7_delete on table test
 drop_rollup 
-------------
 
(1 row)

drop table test cascade;
NOTICE:  drop cascades to 7 other objects
DETAIL:  drop cascades to view test_rollup1_groundtruth_raw
drop cascades to view test_rollup2_groundtruth_raw
drop cascades to view test_rollup3_groundtruth_raw
drop cascades to view test_rollup4_groundtruth_raw
drop cascades to view test_rollup5_groundtruth_raw
drop cascades to view test_rollup6_groundtruth_raw
drop cascades to view test_rollup7_groundtruth_raw
